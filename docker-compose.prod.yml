# 生产环境 Docker Compose 配置
# 包含完整的业务服务 + LiveKit + Redis + Nginx
#
# 使用方式：
#   docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ============================================================================
  # 业务服务（TgoRTCServer）
  # ============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: tgo-rtc-server:latest
    container_name: tgo-rtc-server
    ports:
      - "8080:8080"
    environment:
      - GIN_MODE=release
      - LOG_LEVEL=info
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LIVEKIT_URL=http://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - TZ=${TZ:-UTC}
    networks:
      - livekit
    depends_on:
      redis:
        condition: service_healthy
      livekit:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./logs:/app/logs

  # ============================================================================
  # Nginx 反向代理 + 负载均衡
  # ============================================================================
  nginx:
    image: nginx:${NGINX_IMAGE_VERSION:-alpine}
    container_name: livekit-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./livekit-deployment/config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./livekit-deployment/volumes/letsencrypt:/etc/letsencrypt:ro
      - ./livekit-deployment/volumes/certbot:/var/www/certbot:ro
    networks:
      - livekit
    restart: unless-stopped
    depends_on:
      - app
      - certbot
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Certbot - Let's Encrypt 证书管理
  # ============================================================================
  certbot:
    image: certbot/certbot:${CERTBOT_IMAGE_VERSION:-latest}
    container_name: livekit-certbot
    volumes:
      - ./livekit-deployment/volumes/letsencrypt:/etc/letsencrypt
      - ./livekit-deployment/volumes/certbot:/var/www/certbot
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done"
    networks:
      - livekit
    restart: unless-stopped

  # ============================================================================
  # Redis - 共享数据存储和消息总线
  # ============================================================================
  redis:
    image: redis:${REDIS_IMAGE_VERSION:-7-alpine}
    container_name: livekit-redis
    ports:
      - "6379:6379"
    volumes:
      - ./livekit-deployment/config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis_data:/data
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - livekit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - TZ=${TZ:-UTC}

  # ============================================================================
  # LiveKit 服务器
  # ============================================================================
  livekit:
    image: livekit/livekit-server:${LIVEKIT_IMAGE_VERSION:-latest}
    container_name: livekit-server
    ports:
      - "7880:7880"
      - "7881:7880"
      - "7882:7880"
      - "50000-60000:50000-60000/udp"
      - "3478:3478/udp"
    volumes:
      - ./livekit-deployment/config/livekit.yaml:/etc/livekit.yaml:ro
    environment:
      - LIVEKIT_CONFIG=/etc/livekit.yaml
      - TZ=${TZ:-UTC}
    command: --config /etc/livekit.yaml
    networks:
      - livekit
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7880/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  livekit:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
    driver: local

