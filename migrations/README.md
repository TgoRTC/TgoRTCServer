# 数据库迁移脚本

本目录包含所有的数据库迁移脚本，用于支持在线升级功能。

## 工作原理

应用程序启动时会自动：
1. 从 `migrations/` 目录读取所有 `.sql` 文件
2. 按版本号排序
3. 检查 `migrations` 表中是否已执行过该迁移
4. 如果未执行，则自动执行该迁移脚本
5. 记录迁移的执行情况到 `migrations` 表

## 目录结构

```
migrations/
├── 20251027-01.sql                            # 创建房间表
├── 20251027-02.sql                            # 创建参与者表
├── 20251027-03.sql                            # 添加索引
└── README.md                                   # 本文件
```

## 迁移脚本命名规范

迁移脚本采用以下命名规范：

```
{日期}-{序号}.sql
```

- **日期**: 8位数字，格式为 YYYYMMDD（例如 20251027）
- **序号**: 2位数字，从 01 开始递增（01, 02, 03, ...）

**示例**：
- `20251027-01.sql` - 2025年10月27日的第1个迁移
- `20251027-02.sql` - 2025年10月27日的第2个迁移
- `20251028-01.sql` - 2025年10月28日的第1个迁移

**优势**：
- 📅 清晰的时间戳，便于追踪迁移的创建时间
- 🔢 简单的序号，避免版本号冲突
- 📊 易于按时间排序和管理

## 迁移脚本执行流程

1. **应用启动时**
   - 系统会自动从 `migrations/` 目录读取所有 `.sql` 文件
   - 按版本号（文件名前缀）排序
   - 检查 `migrations` 表中是否已执行过该迁移
   - 如果未执行，则执行该迁移脚本

2. **迁移记录**
   - 每个迁移的执行情况都会记录在 `migrations` 表中
   - 包括版本号、名称、SQL 语句、执行状态、执行时间等

## 优势

✅ **单一数据源** - SQL 脚本只需维护一份，在 `migrations/` 目录中
✅ **自动加载** - 应用启动时自动发现和执行新的迁移脚本
✅ **版本控制友好** - SQL 文件可以直接提交到 Git
✅ **易于审查** - 每个迁移脚本都是独立的文件，便于代码审查
✅ **灵活扩展** - 无需修改代码，只需添加新的 SQL 文件

## 如何添加新的迁移

### 步骤 1: 创建 SQL 脚本文件

在 `migrations/` 目录下创建新的 SQL 文件，命名为 `{日期}-{序号}.sql`

例如：`20251028-01.sql`

```sql
-- Migration 20251028-01: Add new column
-- Description: 为 call_room 表添加新字段
-- Created: 2025-10-28

ALTER TABLE call_room ADD COLUMN new_column VARCHAR(100) DEFAULT '' COMMENT '新字段';
```

**注意：**
- 日期必须是 8 位数字，格式为 YYYYMMDD（例如 20251027）
- 序号必须是 2 位数字，从 01 开始递增
- 文件名中的注释行（以 `--` 开头）会被自动忽略
- 空行也会被自动忽略

### 步骤 2: 重启应用

重启应用程序，系统会自动：
1. 发现新的 SQL 文件
2. 按版本号排序
3. 执行未执行过的迁移脚本
4. 记录迁移历史

**就这样！** 无需修改任何代码。

## 迁移脚本最佳实践

1. **原子性**: 每个迁移脚本应该是原子的，要么全部成功，要么全部失败
2. **可回滚**: 尽可能编写可回滚的迁移脚本
3. **向后兼容**: 确保迁移脚本与现有代码兼容
4. **测试**: 在生产环境前充分测试迁移脚本
5. **文档**: 为每个迁移脚本添加清晰的注释和描述

## 查看迁移表

```bash
# 查看所有迁移记录
mysql -u root tgo_call -e "SELECT version, name, status, executed_at FROM migrations;"

# 查看失败的迁移
mysql -u root tgo_call -e "SELECT * FROM migrations WHERE status = 'failed';"

# 查看迁移统计
mysql -u root tgo_call -e "SELECT status, COUNT(*) as count FROM migrations GROUP BY status;"
```

## 常见问题

### Q: 如何回滚迁移？
A: 目前系统不支持自动回滚。如果需要回滚，请手动执行回滚 SQL 脚本，并在 `migrations` 表中更新相应的记录。

### Q: 如何跳过某个迁移？
A: 在 `migrations` 表中手动插入一条记录，标记该迁移为已执行。

### Q: 迁移失败了怎么办？
A: 检查 `migrations` 表中的 `error` 字段查看错误信息，修复问题后重新启动应用。

## 相关文件

- `internal/database/migration.go` - 迁移管理器实现
- `internal/database/migrations.go` - 迁移脚本定义
- `internal/database/db.go` - 数据库初始化

