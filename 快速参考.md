# LiveKit URL 快速参考

## 核心答案

**`LiveKitConfig.URL` 是 Caddy 反向代理的地址，而不是三个服务器中的任何一个。**

```
✅ 正确: https://livekit.example.com
❌ 错误: https://192.168.1.10
❌ 错误: https://192.168.1.11
❌ 错误: https://192.168.1.12
```

---

## 一句话总结

**前端连接到 Caddy，Caddy 负责分配到最优的 LiveKit 节点。**

---

## 配置速查表

### 后端环境变量

```bash
export LIVEKIT_API_KEY=your_api_key
export LIVEKIT_API_SECRET=your_api_secret
export LIVEKIT_URL=https://livekit.example.com  # ✅ Caddy 地址
```

### 后端代码

```go
response := CreateRoomResponse{
    URL:       liveKitConfig.URL,  // https://livekit.example.com
    ServerURL: liveKitConfig.URL,  // https://livekit.example.com
}
```

### 前端代码

```javascript
const data = await response.json();
await room.connect(data.url, data.token, {...});  // 使用 Caddy 地址
```

---

## 为什么是 Caddy 地址？

| 特性 | 具体 IP | Caddy 地址 |
|------|--------|----------|
| 负载均衡 | ❌ | ✅ |
| 故障转移 | ❌ | ✅ |
| 代码修改 | ✅ 需要 | ❌ 不需要 |
| 扩展性 | ❌ 差 | ✅ 好 |

---

## 架构图

```
前端 → Caddy (https://livekit.example.com)
       ↓
       ├→ Node 1 (192.168.1.10)
       ├→ Node 2 (192.168.1.11)
       └→ Node 3 (192.168.1.12)
```

---

## 常见错误

### ❌ 错误 1: 返回具体的 IP

```go
URL: "https://192.168.1.10"  // ❌ 错误
```

**后果：** 无法负载均衡，无法故障转移

### ❌ 错误 2: 返回 localhost

```go
URL: "https://localhost:7880"  // ❌ 错误
```

**后果：** 前端无法访问

### ❌ 错误 3: 返回 LiveKit 端口

```go
URL: "https://192.168.1.10:7880"  // ❌ 错误
```

**后果：** 绕过 Caddy，无法使用 HTTPS

### ✅ 正确做法

```go
URL: "https://livekit.example.com"  // ✅ 正确
```

---

## 部署检查清单

- [ ] 后端环境变量设置了 `LIVEKIT_URL=https://livekit.example.com`
- [ ] 后端代码返回 Caddy 地址，而不是具体的 IP
- [ ] 前端使用返回的 URL 连接
- [ ] Caddy 配置了反向代理
- [ ] DNS 解析 `livekit.example.com` 到 Caddy 服务器

---

## 快速测试

### 1. 检查后端返回的 URL

```bash
curl -X POST http://localhost:8080/api/create-room \
  -H "Content-Type: application/json" \
  -d '{"room_name":"test","user_name":"user"}'
```

**预期响应：**
```json
{
  "url": "https://livekit.example.com",
  "server_url": "https://livekit.example.com"
}
```

### 2. 检查 Caddy 配置

```bash
curl -I https://livekit.example.com
```

**预期响应：** HTTP 200 或 101 (WebSocket)

### 3. 检查 DNS 解析

```bash
nslookup livekit.example.com
```

**预期响应：** 解析到 Caddy 服务器的 IP

---

## 总结表

| 项目 | 值 |
|------|-----|
| **URL** | `https://livekit.example.com` |
| **是否是 Caddy 地址** | ✅ 是 |
| **是否是具体的 IP** | ❌ 不是 |
| **支持负载均衡** | ✅ 是 |
| **支持故障转移** | ✅ 是 |
| **需要修改代码** | ❌ 不需要 |

---

## 相关文档

- **LIVEKIT-URL-EXPLANATION.md** - 详细解释
- **DEPLOYMENT-FAQ.md** - 部署常见问题
- **example-create-room.go** - 后端示例代码
- **example-create-room.html** - 前端示例代码

