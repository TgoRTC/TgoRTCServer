# 数据库字段说明

## 概述

本项目使用 **MySQL** 数据库存储 Call 房间和参与者信息。包含两个主要表：`call_room`（房间表）和 `call_participant`（参与者表）。

---

## 数据库表结构

### 1. 房间表 (call_room)

房间表用于存储 Call 房间的基本信息和状态。

#### 表结构

```sql
CREATE TABLE IF NOT EXISTS `call_room` (
    id                   integer     not null primary key AUTO_INCREMENT,
    source_channel_id    varchar(100) not null default '',
    source_channel_type  smallint    not null default 0,
    creator              varchar(40) not null default '',
    room_name            varchar(40) not null default '',
    call_type            smallint    not null default 0,
    invite_on            smallint    not null default 0,
    status               smallint    not null default 0,
    created_at           timeStamp   not null DEFAULT CURRENT_TIMESTAMP,
    updated_at           timeStamp   not null DEFAULT CURRENT_TIMESTAMP
);

CREATE unique INDEX call_room_name_idx on `call_room` (room_name);
```

#### 字段说明

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `id` | integer | PRIMARY KEY, AUTO_INCREMENT | 房间记录唯一标识 | `1` |
| `source_channel_id` | varchar(100) | NOT NULL, DEFAULT '' | 所属频道 ID | `channel_123` |
| `source_channel_type` | smallint | NOT NULL, DEFAULT 0 | 频道类型 | `0` |
| `creator` | varchar(40) | NOT NULL, DEFAULT '' | 房间发起者 | `user_001` |
| `room_name` | varchar(40) | NOT NULL, DEFAULT '' | 房间名称（唯一） | `meeting_001` |
| `call_type` | smallint | NOT NULL, DEFAULT 0 | 呼叫类型：0=语音，1=视频 | `1` |
| `invite_on` | smallint | NOT NULL, DEFAULT 0 | 是否开启邀请：0=否，1=是 | `1` |
| `status` | smallint | NOT NULL, DEFAULT 0 | 房间状态：0=未开始，1=进行中，2=已结束，3=已取消 | `1` |
| `created_at` | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 房间创建时间 | `2024-01-15 10:30:00` |
| `updated_at` | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 房间更新时间 | `2024-01-15 10:35:00` |

#### 索引说明

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| `call_room_name_idx` | `room_name` | UNIQUE | 房间名称唯一索引，用于快速查询房间 |

---

### 2. 参与者表 (call_participant)

参与者表用于存储房间内参与者的信息和状态。

#### 表结构

```sql
CREATE TABLE IF NOT EXISTS `call_participant` (
    id                   integer     not null primary key AUTO_INCREMENT,
    room_name            varchar(40) not null default '',
    uid                  varchar(40) not null default '',
    status               smallint    not null default 0,
    join_time            bigint      not null default 0,
    leave_time           bigint      not null default 0,
    created_at           timeStamp   not null DEFAULT CURRENT_TIMESTAMP,
    updated_at           timeStamp   not null DEFAULT CURRENT_TIMESTAMP
);

CREATE unique INDEX call_room_name_uid_idx on `call_participant` (room_name, uid);
CREATE INDEX call_participant_uid_idx on `call_participant` (uid);
```

#### 字段说明

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `id` | integer | PRIMARY KEY, AUTO_INCREMENT | 参与者记录唯一标识 | `1` |
| `room_name` | varchar(40) | NOT NULL, DEFAULT '' | 房间名称 | `meeting_001` |
| `uid` | varchar(40) | NOT NULL, DEFAULT '' | 用户 ID | `user_001` |
| `status` | smallint | NOT NULL, DEFAULT 0 | 参与者状态：0=邀请中，1=已加入，2=已拒绝，3=已挂断，4=超时未加入，5=通话中未接听，6=已取消 | `1` |
| `join_time` | bigint | NOT NULL, DEFAULT 0 | 加入时间（Unix 时间戳，毫秒） | `1705315800000` |
| `leave_time` | bigint | NOT NULL, DEFAULT 0 | 离开时间（Unix 时间戳，毫秒） | `1705319400000` |
| `created_at` | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 记录创建时间 | `2024-01-15 10:30:00` |
| `updated_at` | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 记录更新时间 | `2024-01-15 10:35:00` |

#### 索引说明

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| `call_room_name_uid_idx` | `room_name, uid` | UNIQUE | 房间名称和用户 ID 的联合唯一索引，确保同一用户在同一房间只有一条记录 |
| `call_participant_uid_idx` | `uid` | INDEX | 用户 ID 索引，用于快速查询用户的所有参与记录 |

---

## 字段值说明

### call_type（呼叫类型）

| 值 | 说明 |
|----|------|
| `0` | 语音通话 |
| `1` | 视频通话 |

### invite_on（邀请开关）

| 值 | 说明 |
|----|------|
| `0` | 不开启邀请，任何人都可以加入房间 |
| `1` | 开启邀请，只有收到邀请的人才能加入房间 |

### room status（房间状态）

| 值 | 说明 |
|----|------|
| `0` | 未开始 - 房间已创建但还未开始 |
| `1` | 进行中 - 房间正在进行中 |
| `2` | 已结束 - 房间已正常结束 |
| `3` | 已取消 - 房间已被取消 |

### participant status（参与者状态）

| 值 | 说明 |
|----|------|
| `0` | 邀请中 - 已邀请参与者，但参与者还未加入 |
| `1` | 已加入 - 参与者已加入房间，正在通话中 |
| `2` | 已拒绝 - 参与者拒绝了邀请 |
| `3` | 已挂断 - 参与者已接受邀请并结束了通话 |
| `4` | 超时未加入 - 邀请后参与者在规定时间内未加入 |
| `5` | 通话中未接听 - 通话中参与者未接听 |
| `6` | 已取消 - 邀请已被取消 |

---

## 数据流示例

### 创建房间流程

```
1. 用户请求创建房间
   ↓
2. 插入房间记录到 call_room 表
   INSERT INTO call_room (source_channel_id, creator, room_name, call_type, status)
   ↓
3. 返回房间信息给客户端
```

### 邀请参与者加入房间流程

```
1. 房间创建者邀请参与者
   ↓
2. 插入参与者记录到 call_participant 表，status=0（邀请中）
   INSERT INTO call_participant (room_name, uid, status)
   ↓
3. 发送邀请通知给参与者
```

### 参与者加入房间流程

```
1. 参与者接受邀请，加入房间
   ↓
2. 更新参与者记录，status=1（已加入），设置 join_time
   UPDATE call_participant SET status=1, join_time=? WHERE room_name=? AND uid=?
   ↓
3. 更新房间状态为进行中（如果还未开始）
   UPDATE call_room SET status=1 WHERE room_name=?
```

### 参与者离开房间流程

```
1. 参与者离开房间
   ↓
2. 更新参与者记录，status=3（已挂断），设置 leave_time
   UPDATE call_participant SET status=3, leave_time=? WHERE room_name=? AND uid=?
   ↓
3. 检查房间是否还有其他参与者，如果没有则更新房间状态为已结束
```

---

## 相关文档

- [部署架构指南](部署架构指南.md)
- [部署常见问题](部署常见问题.md)
- [Webhook 配置指南](Webhook配置指南.md)

