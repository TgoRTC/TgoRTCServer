# 部署架构指南

## 架构设计

本项目支持两种部署方式：**单机部署** 和 **分布式部署**。

### 核心理念

- **职责分离** - Caddy + 业务服务 vs LiveKit 完全分离
- **易于升级** - 从单机升级到分布式只需新增 LiveKit 机器
- **易于维护** - 每台机器职责单一，易于理解

---

## 单机部署（2 台机器）

### 架构

```
机器 1 (Caddy + 业务服务):
  ├─ Caddy (80, 443)
  └─ 业务服务 (8080)
     ├─ 创建/加入/离开房间
     └─ Webhook 处理

机器 2 (LiveKit):
  ├─ LiveKit (7880)
  ├─ Redis (6379)
  └─ Webhook 接收
```

### 部署步骤

#### 第 1 步：在机器 1 上部署 Caddy + 业务服务

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env（配置域名等）
nano .env

# 部署 Caddy
./部署.sh deploy-caddy-service-only

# 启动业务服务
go run 你的服务.go
```

#### 第 2 步：在机器 2 上部署 LiveKit

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env
nano .env

# 设置为单机模式
NODES=localhost

# 部署 LiveKit
./部署.sh deploy-livekit-only
```

### 配置示例

**机器 1 (.env)**
```bash
DOMAIN=livekit.example.com
WEBHOOK_ENABLED=true
WEBHOOK_URLS=https://livekit.example.com/api/webhook
WEBHOOK_API_KEY=your_key
```

**机器 2 (.env)**
```bash
NODES=localhost
REDIS_HOST=localhost
REDIS_PORT=6379
LIVEKIT_API_KEY=your_key
LIVEKIT_API_SECRET=your_secret
```

---

## 分布式部署（4+ 台机器）

### 架构

```
机器 1 (Caddy + 业务服务):
  ├─ Caddy (80, 443)
  └─ 业务服务 (8080)

机器 2 (LiveKit - 主节点):
  ├─ LiveKit (7880)
  └─ Redis (6379) ← 主 Redis

机器 3 (LiveKit - 从节点):
  ├─ LiveKit (7880)
  └─ Redis (6379) → 指向机器 2

机器 4 (LiveKit - 从节点):
  ├─ LiveKit (7880)
  └─ Redis (6379) → 指向机器 2
```

### 部署步骤

#### 第 1 步：在机器 1 上部署 Caddy + 业务服务

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env
nano .env

# 部署 Caddy
./部署.sh deploy-caddy-service-only

# 启动业务服务
go run 你的服务.go
```

#### 第 2 步：在机器 2 上部署 LiveKit（主节点）

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env
nano .env

# 设置为分布式模式
NODES=192.168.1.2,192.168.1.3,192.168.1.4

# 部署 LiveKit
./部署.sh deploy-livekit-only
```

#### 第 3 步：在机器 3, 4 上部署 LiveKit（从节点）

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env
nano .env

# 设置为分布式模式（与机器 2 相同）
NODES=192.168.1.2,192.168.1.3,192.168.1.4

# 修改 Redis 配置指向机器 2
REDIS_HOST=192.168.1.2
REDIS_PORT=6379

# 部署 LiveKit
./部署.sh deploy-livekit-only
```

### 配置示例

**机器 1 (.env)**
```bash
DOMAIN=livekit.example.com
WEBHOOK_ENABLED=true
WEBHOOK_URLS=https://livekit.example.com/api/webhook
WEBHOOK_API_KEY=your_key
```

**机器 2 (.env)**
```bash
NODES=192.168.1.2,192.168.1.3,192.168.1.4
REDIS_HOST=localhost
REDIS_PORT=6379
LIVEKIT_API_KEY=your_key
LIVEKIT_API_SECRET=your_secret
```

**机器 3, 4 (.env)**
```bash
NODES=192.168.1.2,192.168.1.3,192.168.1.4
REDIS_HOST=192.168.1.2        # 指向机器 2
REDIS_PORT=6379
LIVEKIT_API_KEY=your_key
LIVEKIT_API_SECRET=your_secret
```

---

## 升级路径

### 从单机升级到分布式

**现在（单机）**
```
机器 1: Caddy + 业务服务
机器 2: LiveKit
```

**升级到分布式**
```
机器 1: Caddy + 业务服务 (不需要改)
机器 2: LiveKit (修改 NODES)
机器 3, 4: LiveKit (新增)
```

**升级步骤**

1. 新增机器 3, 4
2. 在机器 2, 3, 4 上修改 .env 中的 NODES 配置
3. 在机器 2, 3, 4 上执行 `./部署.sh deploy-livekit-only`
4. 重启 LiveKit

**机器 1 无需任何改动！**

---

## 部署命令速查

### 单机部署

```bash
# 机器 1
./部署.sh deploy-caddy-service-only
go run 你的服务.go

# 机器 2
NODES=localhost ./部署.sh deploy-livekit-only
```

### 分布式部署

```bash
# 机器 1
./部署.sh deploy-caddy-service-only
go run 你的服务.go

# 机器 2, 3, 4
NODES=192.168.1.2,192.168.1.3,192.168.1.4 ./部署.sh deploy-livekit-only
```

### 管理命令

```bash
# 启动服务
./部署.sh start

# 停止服务
./部署.sh stop

# 重启服务
./部署.sh restart

# 查看日志
./部署.sh logs livekit

# 备份数据
./部署.sh backup

# 恢复数据
./部署.sh restore /path/to/backup

# 验证部署
./部署.sh verify
```

---

## 网络配置

### DNS 配置

```
livekit.example.com  A  192.168.1.1  (机器 1 的 IP)
```

### 防火墙规则

**机器 1 (Caddy + 业务服务)**
```
80/TCP   → 允许（HTTP）
443/TCP  → 允许（HTTPS）
8080/TCP → 允许（业务服务）
```

**机器 2, 3, 4 (LiveKit)**
```
7880/TCP        → 允许（LiveKit）
3478/TCP/UDP    → 允许（TURN）
5349/TCP        → 允许（TURN TLS）
50000-60000/UDP → 允许（WebRTC）
6379/TCP        → 允许（Redis）
```

---

## 常见问题

### Q1: 为什么要分离 Caddy 和 LiveKit？

**答案：**
- 职责清晰
- 易于维护
- 易于扩展
- 易于升级

### Q2: 业务服务可以和 LiveKit 在同一机器吗？

**答案：** 可以，但不推荐。推荐的架构是：
- 机器 1: Caddy + 业务服务
- 机器 2+: LiveKit

### Q3: 如何从单机升级到分布式？

**答案：**
1. 新增 2 台机器
2. 在新机器上部署 LiveKit
3. 修改 NODES 配置
4. 重启 LiveKit

### Q4: Redis 需要高可用吗？

**答案：** 对于生产环境，建议使用 Redis 集群或主从复制。

### Q5: 如何监控部署？

**答案：**
```bash
# 查看日志
./监控.sh logs livekit

# 查看状态
./监控.sh status

# 故障排查
./故障排查.sh
```

---

## 最佳实践

1. **职责分离** - Caddy + 业务服务 vs LiveKit 分开部署
2. **配置管理** - 使用 .env 文件管理配置
3. **监控告警** - 定期检查日志和性能指标
4. **备份恢复** - 定期备份 Redis 数据
5. **安全加固** - 使用防火墙限制访问
6. **性能优化** - 根据并发数调整 LiveKit 节点数

---

## 总结

| 项目 | 单机 | 分布式 |
|------|------|--------|
| **机器数** | 2 台 | 4+ 台 |
| **Caddy + 服务** | 机器 1 | 机器 1 |
| **LiveKit** | 机器 2 | 机器 2+ |
| **并发连接** | ~500 | ~1500+ |
| **可用性** | 99% | 99.9% |
| **升级难度** | - | 简单 |

---

## 快速开始

### 单机部署（推荐用于开发）

```bash
# 机器 1
./部署.sh deploy-caddy-service-only
go run 你的服务.go

# 机器 2
NODES=localhost ./部署.sh deploy-livekit-only
```

### 分布式部署（推荐用于生产）

```bash
# 机器 1
./部署.sh deploy-caddy-service-only
go run 你的服务.go

# 机器 2, 3, 4
NODES=192.168.1.2,192.168.1.3,192.168.1.4 ./部署.sh deploy-livekit-only
```

准备好了吗？🚀

