# LiveKit 完整部署 Docker Compose 配置
# 支持单机和集群部署
#
# 使用方式：
#   单机部署：docker-compose up -d
#   集群部署：LIVEKIT_NODES=192.168.1.2:7880,192.168.1.3:7880 docker-compose up -d

version: '3.8'

services:
  # ============================================================================
  # Nginx 反向代理 + 负载均衡
  # ============================================================================
  nginx:
    image: nginx:${NGINX_IMAGE_VERSION:-alpine}
    container_name: livekit-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./livekit-deployment/config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./livekit-deployment/volumes/letsencrypt:/etc/letsencrypt:ro
      - ./livekit-deployment/volumes/certbot:/var/www/certbot:ro
    networks:
      - livekit
    restart: unless-stopped
    depends_on:
      - certbot
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Certbot - Let's Encrypt 证书管理
  # ============================================================================
  certbot:
    image: certbot/certbot:${CERTBOT_IMAGE_VERSION:-latest}
    container_name: livekit-certbot
    volumes:
      - ./livekit-deployment/volumes/letsencrypt:/etc/letsencrypt
      - ./livekit-deployment/volumes/certbot:/var/www/certbot
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done"
    networks:
      - livekit
    restart: unless-stopped

  # ============================================================================
  # Redis - 共享数据存储和消息总线
  # 单机模式：内置 Redis
  # 集群模式：可选（如果 LIVEKIT_NODES 不为空，则不启动此服务）
  # ============================================================================
  redis:
    image: redis:${REDIS_IMAGE_VERSION:-7-alpine}
    container_name: livekit-redis
    ports:
      - "6379:6379"
    volumes:
      - ./livekit-deployment/config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis_data:/data
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - livekit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - TZ=${TZ:-UTC}

  # ============================================================================
  # LiveKit 服务器
  # 单机模式：内置 LiveKit
  # 集群模式：可选（如果 LIVEKIT_NODES 不为空，则不启动此服务）
  # ============================================================================
  livekit:
    image: livekit/livekit-server:${LIVEKIT_IMAGE_VERSION:-latest}
    container_name: livekit-server
    ports:
      - "7880:7880"
      - "7881:7880"
      - "7882:7880"
      - "50000-60000:50000-60000/udp"
      - "3478:3478/udp"
    volumes:
      - ./livekit-deployment/config/livekit.yaml:/etc/livekit.yaml:ro
    environment:
      - LIVEKIT_CONFIG=/etc/livekit.yaml
      - TZ=${TZ:-UTC}
    command: --config /etc/livekit.yaml
    networks:
      - livekit
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7880/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  livekit:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
    driver: local

