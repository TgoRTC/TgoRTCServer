# TgoRTC Server 完整部署配置
#
# 使用方式：
#   docker compose up -d
#
# 环境变量：
#   复制 .env.example 为 .env 并修改配置

version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: tgo-rtc-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      TZ: Asia/Shanghai
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3307:3306"
    networks:
      - tgo-rtc-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: tgo-rtc-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "0.0.0.0:6380:6379"
    networks:
      - tgo-rtc-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  livekit:
    image: livekit/livekit-server:latest
    container_name: tgo-rtc-livekit
    restart: always
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    ports:
      - "7880:7880"
      - "7881:7881"
      - "3478:3478/udp"
      - "5349:5349"
      - "50000-50100:50000-50100/udp"
    networks:
      - tgo-rtc-network

  adminer:
    image: adminer
    container_name: tgo-rtc-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    networks:
      - tgo-rtc-network
    environment:
      - ADMINER_DEFAULT_SERVER=tgo-rtc-mysql

  tgo-rtc-server:
    image: ${DOCKER_IMAGE:-crpi-4ja8peh93d2yb8c8.cn-shanghai.personal.cr.aliyuncs.com/slun/tgortc:latest}
    container_name: tgo-rtc-server
    restart: always
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=0
      - LIVEKIT_URL=http://host.docker.internal:80
      - LIVEKIT_CLIENT_URL=${LIVEKIT_CLIENT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - LIVEKIT_TIMEOUT=${LIVEKIT_TIMEOUT}
      - PARTICIPANT_TIMEOUT_CHECK_INTERVAL=${PARTICIPANT_TIMEOUT_CHECK_INTERVAL}
      - PORT=8080
      - BUSINESS_WEBHOOK_ENDPOINTS=${BUSINESS_WEBHOOK_ENDPOINTS}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      livekit:
        condition: service_started
    networks:
      - tgo-rtc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
  redis_data:

networks:
  tgo-rtc-network:
    driver: bridge
