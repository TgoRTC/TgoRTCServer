# 项目结构说明

## 目录结构

```
tgo-call-server/
├── main.go                          # 主程序入口
├── go.mod                           # Go 模块定义
├── go.sum                           # Go 依赖锁定文件
├── .env.example                     # 环境变量示例
├── API_文档.md                      # API 接口文档
├── 项目结构说明.md                  # 本文件
├── 数据库字段说明.md                # 数据库字段文档
├── internal/                        # 内部包
│   ├── config/
│   │   └── config.go               # 配置管理
│   ├── database/
│   │   ├── db.go                   # 数据库初始化
│   │   └── redis.go                # Redis 初始化
│   ├── models/
│   │   ├── room.go                 # 房间数据模型
│   │   └── participant.go          # 参与者数据模型
│   ├── service/
│   │   ├── room_service.go         # 房间业务逻辑
│   │   └── participant_service.go  # 参与者业务逻辑
│   ├── handler/
│   │   ├── room_handler.go         # 房间 API 处理器
│   │   └── participant_handler.go  # 参与者 API 处理器
│   ├── livekit/
│   │   └── token.go                # LiveKit Token 生成
│   └── router/
│       └── router.go               # 路由配置
└── 部署相关文件/
    ├── 部署.sh                      # 部署脚本
    ├── 监控.sh                      # 监控脚本
    ├── 故障排查.sh                  # 故障排查脚本
    ├── 部署架构指南.md              # 部署架构文档
    ├── 部署常见问题.md              # 常见问题解答
    ├── Webhook配置指南.md           # Webhook 配置文档
    ├── Webhook处理示例.go           # Webhook 处理示例
    └── 快速参考.md                  # 快速参考
```

## 核心模块说明

### 1. main.go - 主程序入口

程序的入口点，负责：
- 加载环境变量
- 初始化配置
- 初始化数据库和 Redis
- 设置路由
- 启动 HTTP 服务器

### 2. internal/config - 配置管理

**config.go**: 
- 定义 `Config` 结构体，包含所有配置项
- `LoadConfig()` 函数从环境变量加载配置
- 支持默认值设置

### 3. internal/database - 数据库和缓存

**db.go**:
- `InitDB()` 初始化 MySQL 数据库连接
- 自动执行数据库迁移
- 使用 GORM ORM 框架

**redis.go**:
- `InitRedis()` 初始化 Redis 连接
- 测试连接可用性

### 4. internal/models - 数据模型

**room.go**:
- `Room` 结构体：房间数据模型
- 请求/响应结构体：`CreateRoomRequest`, `CreateRoomResponse` 等
- 常量定义：房间状态、呼叫类型等

**participant.go**:
- `Participant` 结构体：参与者数据模型
- 请求/响应结构体：`JoinRoomRequest`, `JoinRoomResponse` 等
- 常量定义：参与者状态等

### 5. internal/service - 业务逻辑层

**room_service.go**:
- `RoomService` 结构体
- 方法：`CreateRoom()`, `GetRoom()`, `UpdateRoomStatus()`, `EndRoom()`, `ListRooms()`
- 处理房间相关的业务逻辑

**participant_service.go**:
- `ParticipantService` 结构体
- 方法：`JoinRoom()`, `LeaveRoom()`, `GetParticipants()`, `InviteParticipants()`, `UpdateParticipantStatus()`
- 处理参与者相关的业务逻辑

### 6. internal/handler - API 处理器层

**room_handler.go**:
- `RoomHandler` 结构体
- HTTP 处理函数：`CreateRoom()`, `GetRoom()`, `UpdateRoomStatus()`, `EndRoom()`, `ListRooms()`
- 处理 HTTP 请求和响应

**participant_handler.go**:
- `ParticipantHandler` 结构体
- HTTP 处理函数：`JoinRoom()`, `LeaveRoom()`, `GetParticipants()`, `InviteParticipants()`, `UpdateParticipantStatus()`
- 处理 HTTP 请求和响应

### 7. internal/livekit - LiveKit 集成

**token.go**:
- `TokenGenerator` 结构体
- 方法：`GenerateToken()`, `GenerateTokenWithExpiry()`
- 生成 LiveKit 访问令牌

### 8. internal/router - 路由配置

**router.go**:
- `SetupRouter()` 函数设置所有路由
- 定义 API 端点和对应的处理函数
- 组织路由分组

## 数据流

### 创建房间流程

```
HTTP Request (POST /api/rooms)
    ↓
RoomHandler.CreateRoom()
    ↓
RoomService.CreateRoom()
    ↓
Database (Insert into livekit_room)
    ↓
TokenGenerator.GenerateToken()
    ↓
HTTP Response (CreateRoomResponse)
```

### 参与者加入房间流程

```
HTTP Request (POST /api/participants/join)
    ↓
ParticipantHandler.JoinRoom()
    ↓
ParticipantService.JoinRoom()
    ↓
Database (Insert/Update livekit_participant)
    ↓
TokenGenerator.GenerateToken()
    ↓
HTTP Response (JoinRoomResponse)
```

## 依赖关系

```
main.go
  ├── config.LoadConfig()
  ├── database.InitDB()
  ├── database.InitRedis()
  └── router.SetupRouter()
      ├── RoomHandler
      │   └── RoomService
      │       ├── Database (GORM)
      │       └── TokenGenerator
      └── ParticipantHandler
          └── ParticipantService
              ├── Database (GORM)
              └── TokenGenerator
```

## 开发指南

### 添加新的 API 接口

1. **定义模型** (internal/models/)
   - 创建请求/响应结构体

2. **实现业务逻辑** (internal/service/)
   - 在对应的 Service 中添加方法

3. **创建处理器** (internal/handler/)
   - 在对应的 Handler 中添加 HTTP 处理函数

4. **配置路由** (internal/router/)
   - 在 `SetupRouter()` 中添加路由

### 数据库操作

所有数据库操作都通过 GORM 进行，示例：

```go
// 创建
db.Create(&room)

// 查询
db.Where("room_name = ?", roomName).First(&room)

// 更新
db.Model(&room).Update("status", status)

// 删除
db.Delete(&room)
```

### 错误处理

统一的错误处理模式：

```go
if err != nil {
    return nil, fmt.Errorf("操作失败: %w", err)
}
```

## 配置说明

详见 `.env.example` 文件，主要配置项：

- **PORT**: 服务端口（默认 8080）
- **DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME**: 数据库配置
- **REDIS_HOST/REDIS_PORT/REDIS_PASSWORD/REDIS_DB**: Redis 配置
- **LIVEKIT_URL/LIVEKIT_API_KEY/LIVEKIT_API_SECRET**: LiveKit 配置

## 部署

详见 [部署架构指南.md](部署架构指南.md)

## 常见问题

详见 [部署常见问题.md](部署常见问题.md)

