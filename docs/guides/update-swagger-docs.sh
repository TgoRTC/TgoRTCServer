#!/bin/bash

# Swagger æ–‡æ¡£è‡ªåŠ¨æ›´æ–°è„šæœ¬
# ç”¨é€”: è‡ªåŠ¨å°† swagger.yaml è½¬æ¢ä¸º swagger.json å¹¶æ›´æ–° docs.go
# ä½¿ç”¨: ./update-swagger-docs.sh

set -e

echo "ğŸ”„ å¼€å§‹æ›´æ–° Swagger æ–‡æ¡£..."
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
if [ ! -f "docs/swagger.yaml" ]; then
    echo -e "${RED}âŒ é”™è¯¯: æ‰¾ä¸åˆ° docs/swagger.yaml${NC}"
    exit 1
fi

echo -e "${YELLOW}ğŸ“ æ­¥éª¤ 1: éªŒè¯ YAML è¯­æ³•${NC}"
if command -v yamllint &> /dev/null; then
    if yamllint docs/swagger.yaml; then
        echo -e "${GREEN}âœ… YAML è¯­æ³•æ­£ç¡®${NC}"
    else
        echo -e "${RED}âŒ YAML è¯­æ³•é”™è¯¯${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}âš ï¸  yamllint æœªå®‰è£…ï¼Œè·³è¿‡ YAML éªŒè¯${NC}"
fi

echo ""
echo -e "${YELLOW}ğŸ“ æ­¥éª¤ 2: è½¬æ¢ YAML ä¸º JSON${NC}"

# å°è¯•ä½¿ç”¨ yq è½¬æ¢
if command -v yq &> /dev/null; then
    yq eval -o=json docs/swagger.yaml > docs/swagger.json
    echo -e "${GREEN}âœ… ä½¿ç”¨ yq è½¬æ¢æˆåŠŸ${NC}"
elif command -v python3 &> /dev/null; then
    python3 << 'PYTHON_EOF'
import yaml
import json
import sys

try:
    with open('docs/swagger.yaml', 'r', encoding='utf-8') as f:
        yaml_data = yaml.safe_load(f)
    
    with open('docs/swagger.json', 'w', encoding='utf-8') as f:
        json.dump(yaml_data, f, ensure_ascii=False, indent=2)
    
    print("âœ… ä½¿ç”¨ Python è½¬æ¢æˆåŠŸ")
except Exception as e:
    print(f"âŒ è½¬æ¢å¤±è´¥: {e}", file=sys.stderr)
    sys.exit(1)
PYTHON_EOF
else
    echo -e "${RED}âŒ éœ€è¦å®‰è£… yq æˆ– Python 3${NC}"
    echo "   macOS: brew install yq"
    echo "   Linux: apt-get install yq"
    exit 1
fi

echo ""
echo -e "${YELLOW}ğŸ“ æ­¥éª¤ 3: éªŒè¯ JSON è¯­æ³•${NC}"

if command -v python3 &> /dev/null; then
    if python3 -m json.tool docs/swagger.json > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… JSON æ ¼å¼æ­£ç¡®${NC}"
    else
        echo -e "${RED}âŒ JSON æ ¼å¼é”™è¯¯${NC}"
        exit 1
    fi
elif command -v jq &> /dev/null; then
    if jq empty docs/swagger.json 2>/dev/null; then
        echo -e "${GREEN}âœ… JSON æ ¼å¼æ­£ç¡®${NC}"
    else
        echo -e "${RED}âŒ JSON æ ¼å¼é”™è¯¯${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}âš ï¸  è·³è¿‡ JSON éªŒè¯${NC}"
fi

echo ""
echo -e "${YELLOW}ğŸ“ æ­¥éª¤ 4: æ›´æ–° docs.go${NC}"

# è¯»å– swagger.json å†…å®¹
SWAGGER_JSON=$(cat docs/swagger.json)

# åˆ›å»ºæ–°çš„ docs.go
cat > docs/docs.go << 'EOF'
// Package docs Code generated by swaggo/swag. DO NOT EDIT
package docs

import "github.com/swaggo/swag"

const docTemplate = `
EOF

# æ·»åŠ  JSON å†…å®¹
echo "$SWAGGER_JSON" >> docs/docs.go

cat >> docs/docs.go << 'EOF'
`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &swag.Spec{
	Version:          "1.0.0",
	Host:             "localhost:8080",
	BasePath:         "/api/v1",
	Schemes:          []string{},
	Title:            "TgoRTC Server API",
	Description:      "åŸºäº LiveKit çš„éŸ³è§†é¢‘æœåŠ¡ API",
	InfoInstanceName: "swagger",
	SwaggerTemplate:  docTemplate,
	LeftDelim:        "{{",
	RightDelim:       "}}",
}

func init() {
	swag.Register("swagger", SwaggerInfo)
}
EOF

echo -e "${GREEN}âœ… docs.go å·²æ›´æ–°${NC}"

echo ""
echo -e "${YELLOW}ğŸ“ æ­¥éª¤ 5: æ„å»ºé¡¹ç›®${NC}"

if go build -o tgo-rtc-server 2>&1; then
    echo -e "${GREEN}âœ… æ„å»ºæˆåŠŸ${NC}"
else
    echo -e "${RED}âŒ æ„å»ºå¤±è´¥${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆï¼${NC}"
echo ""
echo "ğŸ“Š æ›´æ–°æ‘˜è¦:"
echo "  - docs/swagger.yaml: å·²éªŒè¯"
echo "  - docs/swagger.json: å·²æ›´æ–°"
echo "  - docs/docs.go: å·²æ›´æ–°"
echo "  - é¡¹ç›®: å·²æ„å»º"
echo ""
echo "ğŸš€ å¯åŠ¨æœåŠ¡:"
echo "  ./tgo-rtc-server"
echo ""
echo "ğŸ“– è®¿é—® Swagger UI:"
echo "  http://localhost:8080/swagger/index.html"

