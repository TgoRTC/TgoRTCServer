# Swagger æ–‡æ¡£æ›´æ–°æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨æ›´æ–°ä»£ç ååŒæ­¥æ›´æ–° Swagger API æ–‡æ¡£ã€‚

## ğŸ“‹ ç›®å½•
1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [æ›´æ–°æµç¨‹](#æ›´æ–°æµç¨‹)
3. [å¸¸è§åœºæ™¯](#å¸¸è§åœºæ™¯)
4. [éªŒè¯æ­¥éª¤](#éªŒè¯æ­¥éª¤)
5. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## å¿«é€Ÿå¼€å§‹

### é¡¹ç›®ç»“æ„
```
docs/
â”œâ”€â”€ docs.go           â† Swagger æ–‡æ¡£å®šä¹‰ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ swagger.yaml      â† OpenAPI 3.0 YAML æ ¼å¼
â””â”€â”€ swagger.json      â† OpenAPI 3.0 JSON æ ¼å¼
```

### è®¿é—® Swagger UI
```
http://localhost:8080/swagger/index.html
```

---

## æ›´æ–°æµç¨‹

### æ­¥éª¤ 1: æ›´æ–° `docs/swagger.yaml`

å½“ä½ æ·»åŠ æˆ–ä¿®æ”¹ API ç«¯ç‚¹æ—¶ï¼Œé¦–å…ˆæ›´æ–° YAML æ–‡ä»¶ï¼š

#### 1.1 æ·»åŠ æ–°çš„ API ç«¯ç‚¹

åœ¨ `docs/swagger.yaml` çš„ `paths` éƒ¨åˆ†æ·»åŠ æ–°ç«¯ç‚¹ï¼š

```yaml
paths:
  /api/v1/new-endpoint:
    post:
      tags:
        - åŠŸèƒ½åˆ†ç±»
      summary: ç®€çŸ­æè¿°
      description: è¯¦ç»†æè¿°
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - field1
              properties:
                field1:
                  type: string
                  example: "example_value"
      responses:
        '200':
          description: æˆåŠŸå“åº”
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
        '500':
          description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
```

#### 1.2 ä¿®æ”¹ç°æœ‰ç«¯ç‚¹

æ‰¾åˆ°å¯¹åº”çš„ç«¯ç‚¹ï¼Œæ›´æ–°å…¶å®šä¹‰ï¼š

```yaml
paths:
  /api/v1/rooms:
    post:
      # æ›´æ–° summaryã€descriptionã€parameters ç­‰
      summary: æ›´æ–°åçš„æè¿°
      # ...
```

#### 1.3 æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹

åœ¨ `components/schemas` éƒ¨åˆ†æ·»åŠ æ–°çš„æ•°æ®ç»“æ„ï¼š

```yaml
components:
  schemas:
    NewModel:
      type: object
      properties:
        id:
          type: string
          example: "123"
        name:
          type: string
          example: "example"
```

---

### æ­¥éª¤ 2: æ›´æ–° `docs/swagger.json`

`swagger.json` æ˜¯ `swagger.yaml` çš„ JSON æ ¼å¼ç‰ˆæœ¬ã€‚

#### 2.1 è‡ªåŠ¨è½¬æ¢æ–¹å¼ï¼ˆæ¨èï¼‰

ä½¿ç”¨åœ¨çº¿å·¥å…·æˆ–å‘½ä»¤è¡Œå·¥å…·è½¬æ¢ï¼š

**æ–¹å¼ 1: ä½¿ç”¨åœ¨çº¿å·¥å…·**
- è®¿é—® https://www.convertjson.com/yaml-to-json.html
- å¤åˆ¶ `swagger.yaml` å†…å®¹
- ç²˜è´´åˆ°è½¬æ¢å·¥å…·
- å¤åˆ¶è½¬æ¢åçš„ JSON åˆ° `swagger.json`

**æ–¹å¼ 2: ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·**
```bash
# å®‰è£… yqï¼ˆYAML å¤„ç†å·¥å…·ï¼‰
brew install yq  # macOS
# æˆ–
apt-get install yq  # Linux

# è½¬æ¢ YAML åˆ° JSON
yq eval -o=json docs/swagger.yaml > docs/swagger.json
```

**æ–¹å¼ 3: ä½¿ç”¨ Python**
```bash
python3 << 'EOF'
import yaml
import json

with open('docs/swagger.yaml', 'r', encoding='utf-8') as f:
    yaml_data = yaml.safe_load(f)

with open('docs/swagger.json', 'w', encoding='utf-8') as f:
    json.dump(yaml_data, f, ensure_ascii=False, indent=2)

print("âœ… swagger.json å·²æ›´æ–°")
EOF
```

#### 2.2 æ‰‹åŠ¨æ›´æ–°æ–¹å¼

å¦‚æœåªæ˜¯å°æ”¹åŠ¨ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘ `swagger.json`ï¼š

```json
{
  "openapi": "3.0.0",
  "info": {
    "title": "TgoRTC Server API",
    "version": "1.0.0"
  },
  "paths": {
    "/api/v1/new-endpoint": {
      "post": {
        "tags": ["åŠŸèƒ½åˆ†ç±»"],
        "summary": "ç®€çŸ­æè¿°",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "field1": {"type": "string"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {"description": "æˆåŠŸ"}
        }
      }
    }
  }
}
```

---

### æ­¥éª¤ 3: æ›´æ–° `docs/docs.go`

`docs.go` æ˜¯ swaggo åº“ä½¿ç”¨çš„æ–‡ä»¶ï¼ŒåŒ…å« Swagger æ–‡æ¡£çš„å®Œæ•´å®šä¹‰ã€‚

#### 3.1 æ›´æ–° docTemplate

ç¼–è¾‘ `docs/docs.go` ä¸­çš„ `docTemplate` å¸¸é‡ï¼Œå°† `swagger.json` çš„å†…å®¹å¤åˆ¶è¿›å»ï¼š

```go
const docTemplate = `{
  "openapi": "3.0.0",
  "info": {
    "title": "{{.Title}}",
    "description": "{{escape .Description}}",
    "version": "{{.Version}}"
  },
  "paths": {
    "/api/v1/new-endpoint": {
      "post": {
        "tags": ["åŠŸèƒ½åˆ†ç±»"],
        "summary": "ç®€çŸ­æè¿°",
        // ... å®Œæ•´çš„ JSON å†…å®¹
      }
    }
  }
}`
```

**æ³¨æ„äº‹é¡¹ï¼š**
- ä¿ç•™ `{{.Title}}`ã€`{{.Description}}`ã€`{{.Version}}` ç­‰æ¨¡æ¿å˜é‡
- ä½¿ç”¨ `{{escape .Description}}` æ¥è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
- JSON å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ ¼å¼

#### 3.2 å¿«é€Ÿæ›´æ–°è„šæœ¬

åˆ›å»ºä¸€ä¸ªè„šæœ¬è‡ªåŠ¨æ›´æ–° `docs.go`ï¼š

```bash
#!/bin/bash
# æ–‡ä»¶: update-swagger-docs.sh

# è¯»å– swagger.json
SWAGGER_JSON=$(cat docs/swagger.json)

# åˆ›å»ºæ–°çš„ docs.go
cat > docs/docs.go << 'EOF'
// Package docs Code generated by swaggo/swag. DO NOT EDIT
package docs

import "github.com/swaggo/swag"

const docTemplate = `
EOF

# æ·»åŠ  JSON å†…å®¹ï¼ˆéœ€è¦è½¬ä¹‰åå¼•å·ï¼‰
echo "$SWAGGER_JSON" | sed 's/`/\\`/g' >> docs/docs.go

cat >> docs/docs.go << 'EOF'
`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &swag.Spec{
	Version:          "1.0.0",
	Host:             "localhost:8080",
	BasePath:         "/api/v1",
	Schemes:          []string{},
	Title:            "TgoRTC Server API",
	Description:      "åŸºäº LiveKit çš„éŸ³è§†é¢‘æœåŠ¡ API",
	InfoInstanceName: "swagger",
	SwaggerTemplate:  docTemplate,
	LeftDelim:        "{{",
	RightDelim:       "}}",
}

func init() {
	swag.Register("swagger", SwaggerInfo)
}
EOF

echo "âœ… docs.go å·²æ›´æ–°"
```

ä½¿ç”¨æ–¹å¼ï¼š
```bash
chmod +x update-swagger-docs.sh
./update-swagger-docs.sh
```

---

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: æ·»åŠ æ–°çš„ API ç«¯ç‚¹

**æ­¥éª¤ï¼š**

1. **æ›´æ–° `docs/swagger.yaml`**
   ```yaml
   paths:
     /api/v1/users/{user_id}:
       get:
         tags:
           - ç”¨æˆ·ç®¡ç†
         summary: è·å–ç”¨æˆ·ä¿¡æ¯
         parameters:
           - name: user_id
             in: path
             required: true
             schema:
               type: string
         responses:
           '200':
             description: æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯
           '404':
             description: ç”¨æˆ·ä¸å­˜åœ¨
   ```

2. **è½¬æ¢ä¸º JSON**
   ```bash
   yq eval -o=json docs/swagger.yaml > docs/swagger.json
   ```

3. **æ›´æ–° `docs/docs.go`**
   - å¤åˆ¶ `swagger.json` çš„å†…å®¹
   - ç²˜è´´åˆ° `docs.go` çš„ `docTemplate` ä¸­

4. **æ„å»ºå¹¶æµ‹è¯•**
   ```bash
   go build -o tgo-rtc-server
   ./tgo-rtc-server
   # è®¿é—® http://localhost:8080/swagger/index.html
   ```

---

### åœºæ™¯ 2: ä¿®æ”¹ç°æœ‰ç«¯ç‚¹çš„å‚æ•°

**æ­¥éª¤ï¼š**

1. **åœ¨ `docs/swagger.yaml` ä¸­æ‰¾åˆ°å¯¹åº”ç«¯ç‚¹**
   ```yaml
   /api/v1/rooms:
     post:
       requestBody:
         content:
           application/json:
             schema:
               properties:
                 new_field:  # æ·»åŠ æ–°å­—æ®µ
                   type: string
   ```

2. **åŒæ­¥åˆ° `swagger.json` å’Œ `docs.go`**
   - é‡å¤ä¸Šé¢çš„è½¬æ¢æ­¥éª¤

---

### åœºæ™¯ 3: æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹

**æ­¥éª¤ï¼š**

1. **åœ¨ `docs/swagger.yaml` çš„ `components/schemas` ä¸­æ·»åŠ **
   ```yaml
   components:
     schemas:
       User:
         type: object
         properties:
           id:
             type: string
           name:
             type: string
           email:
             type: string
   ```

2. **åœ¨ç«¯ç‚¹ä¸­å¼•ç”¨**
   ```yaml
   responses:
     '200':
       description: æˆåŠŸ
       content:
         application/json:
           schema:
             $ref: '#/components/schemas/User'
   ```

3. **åŒæ­¥åˆ° JSON å’Œ `docs.go`**

---

## éªŒè¯æ­¥éª¤

### éªŒè¯ 1: æ£€æŸ¥ YAML è¯­æ³•

```bash
# ä½¿ç”¨åœ¨çº¿å·¥å…·éªŒè¯
# https://www.yamllint.com/

# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ
yamllint docs/swagger.yaml
```

### éªŒè¯ 2: æ£€æŸ¥ JSON è¯­æ³•

```bash
# éªŒè¯ JSON æ ¼å¼
python3 -m json.tool docs/swagger.json > /dev/null && echo "âœ… JSON æ ¼å¼æ­£ç¡®"

# æˆ–ä½¿ç”¨ jq
jq empty docs/swagger.json && echo "âœ… JSON æ ¼å¼æ­£ç¡®"
```

### éªŒè¯ 3: æ„å»ºé¡¹ç›®

```bash
go build -o tgo-rtc-server
# å¦‚æœæ„å»ºæˆåŠŸï¼Œè¯´æ˜ docs.go æ ¼å¼æ­£ç¡®
```

### éªŒè¯ 4: å¯åŠ¨æœåŠ¡å¹¶è®¿é—® Swagger UI

```bash
./tgo-rtc-server &
sleep 3

# æ£€æŸ¥ Swagger UI æ˜¯å¦å¯è®¿é—®
curl -s http://localhost:8080/swagger/index.html | head -20

# æ£€æŸ¥ swagger.json ç«¯ç‚¹
curl -s http://localhost:8080/api/docs/swagger.json | jq '.paths | keys'

# åœæ­¢æœåŠ¡
pkill -f tgo-rtc-server
```

### éªŒè¯ 5: åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹

1. å¯åŠ¨æœåŠ¡ï¼š`./tgo-rtc-server`
2. æ‰“å¼€æµè§ˆå™¨ï¼š`http://localhost:8080/swagger/index.html`
3. æ£€æŸ¥æ‰€æœ‰ API ç«¯ç‚¹æ˜¯å¦éƒ½æ˜¾ç¤ºäº†
4. å°è¯•å±•å¼€æŸä¸ªç«¯ç‚¹ï¼ŒæŸ¥çœ‹å‚æ•°å’Œå“åº”

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: Swagger UI æ˜¾ç¤º 404

**åŸå› ï¼š** æœåŠ¡æœªå¯åŠ¨æˆ–è·¯ç”±é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
ps aux | grep tgo-rtc-server

# æ£€æŸ¥è·¯ç”±é…ç½®
grep -n "swagger" internal/router/router.go

# é‡æ–°æ„å»º
go build -o tgo-rtc-server
./tgo-rtc-server
```

---

### é—®é¢˜ 2: Swagger UI åªæ˜¾ç¤ºéƒ¨åˆ† API

**åŸå› ï¼š** `docs.go` ä¸­çš„ `docTemplate` ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `docs/swagger.json` æ˜¯å¦åŒ…å«æ‰€æœ‰ç«¯ç‚¹
   ```bash
   cat docs/swagger.json | grep -o '"/api/v1/[^"]*"' | sort -u
   ```

2. ç¡®ä¿ `docs.go` ä¸­çš„ `docTemplate` åŒ…å«å®Œæ•´çš„ JSON
   ```bash
   grep -c "paths" docs/docs.go
   ```

3. é‡æ–°æ›´æ–° `docs.go`

---

### é—®é¢˜ 3: JSON æ ¼å¼é”™è¯¯

**åŸå› ï¼š** æ‰‹åŠ¨ç¼–è¾‘æ—¶å¼•å…¥äº†è¯­æ³•é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# éªŒè¯ JSON
python3 -m json.tool docs/swagger.json

# å¦‚æœæœ‰é”™è¯¯ï¼Œä½¿ç”¨åœ¨çº¿å·¥å…·ä¿®å¤
# https://jsonlint.com/

# æˆ–ä½¿ç”¨ jq æŸ¥çœ‹é”™è¯¯ä½ç½®
jq . docs/swagger.json
```

---

### é—®é¢˜ 4: YAML ä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºé”™è¯¯

**åŸå› ï¼š** æ–‡ä»¶ç¼–ç é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ–‡ä»¶ç¼–ç 
file docs/swagger.yaml

# è½¬æ¢ä¸º UTF-8
iconv -f GBK -t UTF-8 docs/swagger.yaml > docs/swagger.yaml.tmp
mv docs/swagger.yaml.tmp docs/swagger.yaml
```

---

## å®Œæ•´æ›´æ–°æµç¨‹æ€»ç»“

```bash
# 1. ç¼–è¾‘ swagger.yaml
vim docs/swagger.yaml

# 2. éªŒè¯ YAML è¯­æ³•
yamllint docs/swagger.yaml

# 3. è½¬æ¢ä¸º JSON
yq eval -o=json docs/swagger.yaml > docs/swagger.json

# 4. éªŒè¯ JSON è¯­æ³•
python3 -m json.tool docs/swagger.json > /dev/null

# 5. æ›´æ–° docs.goï¼ˆä½¿ç”¨è„šæœ¬æˆ–æ‰‹åŠ¨ï¼‰
./update-swagger-docs.sh

# 6. æ„å»ºé¡¹ç›®
go build -o tgo-rtc-server

# 7. å¯åŠ¨æœåŠ¡æµ‹è¯•
./tgo-rtc-server &
sleep 3

# 8. éªŒè¯ Swagger UI
curl -s http://localhost:8080/swagger/index.html | head -20

# 9. åœæ­¢æœåŠ¡
pkill -f tgo-rtc-server

# 10. æäº¤ä»£ç 
git add docs/
git commit -m "docs: update swagger documentation"
```

---

## å¿«é€Ÿå‚è€ƒ

| æ–‡ä»¶ | ç”¨é€” | ä½•æ—¶æ›´æ–° |
|------|------|--------|
| `docs/swagger.yaml` | OpenAPI 3.0 YAML æ ¼å¼ | æ·»åŠ /ä¿®æ”¹ API æ—¶é¦–å…ˆæ›´æ–° |
| `docs/swagger.json` | OpenAPI 3.0 JSON æ ¼å¼ | ä» YAML è½¬æ¢å¾—åˆ° |
| `docs/docs.go` | swaggo åº“ä½¿ç”¨çš„å®šä¹‰ | ä» JSON å¤åˆ¶å†…å®¹ |

---

## ç›¸å…³èµ„æº

- [OpenAPI 3.0 è§„èŒƒ](https://spec.openapis.org/oas/v3.0.3)
- [Swagger ç¼–è¾‘å™¨](https://editor.swagger.io/)
- [swaggo æ–‡æ¡£](https://github.com/swaggo/swag)
- [YAML éªŒè¯å·¥å…·](https://www.yamllint.com/)
- [JSON éªŒè¯å·¥å…·](https://jsonlint.com/)

---

## å¸¸è§é—®é¢˜ (FAQ)

**Q: æˆ‘åº”è¯¥å…ˆæ›´æ–°å“ªä¸ªæ–‡ä»¶ï¼Ÿ**
A: å§‹ç»ˆå…ˆæ›´æ–° `swagger.yaml`ï¼Œç„¶åè½¬æ¢ä¸º JSONï¼Œæœ€åæ›´æ–° `docs.go`ã€‚

**Q: å¯ä»¥åªæ›´æ–° `docs.go` å—ï¼Ÿ**
A: ä¸å»ºè®®ã€‚åº”è¯¥ä¿æŒä¸‰ä¸ªæ–‡ä»¶åŒæ­¥ï¼Œè¿™æ ·ä¾¿äºç»´æŠ¤å’Œç‰ˆæœ¬æ§åˆ¶ã€‚

**Q: å¦‚ä½•è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Ÿ**
A: ä½¿ç”¨æä¾›çš„ `update-swagger-docs.sh` è„šæœ¬ï¼Œæˆ–é›†æˆåˆ° CI/CD æµç¨‹ä¸­ã€‚

**Q: æ›´æ–°åéœ€è¦é‡å¯æœåŠ¡å—ï¼Ÿ**
A: éœ€è¦é‡æ–°æ„å»ºï¼ˆ`go build`ï¼‰å¹¶é‡å¯æœåŠ¡ã€‚

**Q: å¦‚ä½•åœ¨ Git ä¸­è·Ÿè¸ªè¿™äº›æ–‡ä»¶ï¼Ÿ**
A: å°†æ‰€æœ‰ä¸‰ä¸ªæ–‡ä»¶éƒ½æäº¤åˆ° Gitï¼Œè¿™æ ·å¯ä»¥è¿½è¸ªæ–‡æ¡£çš„å˜åŒ–å†å²ã€‚


