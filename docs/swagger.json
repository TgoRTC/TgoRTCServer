{
  "openapi": "3.0.0",
  "info": {
    "title": "TgoRTC Server API",
    "description": "基于 LiveKit 的音视频服务 API",
    "version": "1.0.0",
    "contact": {
      "name": "API Support",
      "url": "https://github.com/TgoRTC/TgoRTCServer"
    }
  },
  "tags": [
    {
      "name": "房间管理",
      "description": "房间相关的 API 接口"
    },
    {
      "name": "Webhook",
      "description": "Webhook 相关的 API 接口"
    },
    {
      "name": "业务 Webhook",
      "description": "业务系统需要实现的 Webhook 回调接口"
    }
  ],
  "paths": {
    "/api/v1/rooms": {
      "post": {
        "tags": ["房间管理"],
        "summary": "创建房间",
        "description": "创建一个新的音视频房间",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["source_channel_id", "creator"],
                "properties": {
                  "source_channel_id": {
                    "type": "string",
                    "example": "channel_123",
                    "description": "来源渠道 ID"
                  },
                  "source_channel_type": {
                    "type": "integer",
                    "description": "来源渠道类型",
                    "example": 0
                  },
                  "creator": {
                    "type": "string",
                    "description": "房间创建者 ID",
                    "example": "user_001"
                  },
                  "room_id": {
                    "type": "string",
                    "example": "room_abc123"
                  },
                  "rtc_type": {
                    "type": "integer",
                    "description": "呼叫类型（0: 语音, 1: 视频）",
                    "example": 1
                  },
                  "invite_on": {
                    "type": "integer",
                    "description": "是否开启邀请（0: 否, 1: 是）",
                    "example": 1
                  },
                  "max_participants": {
                    "type": "integer",
                    "description": "最大参与者数（默认 2）",
                    "example": 2
                  },
                  "uids": {
                    "type": "array",
                    "description": "邀请的用户 ID 列表",
                    "items": {
                      "type": "string"
                    },
                    "example": ["user_002", "user_003"]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "房间创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "source_channel_id": {
                      "type": "string",
                      "description": "来源渠道 ID"
                    },
                    "source_channel_type": {
                      "type": "integer",
                      "description": "来源渠道类型"
                    },
                    "room_id": {
                      "type": "string",
                      "description": "房间 ID"
                    },
                    "creator": {
                      "type": "string",
                      "description": "房间创建者 ID"
                    },
                    "token": {
                      "type": "string",
                      "description": "LiveKit Token"
                    },
                    "url": {
                      "type": "string",
                      "description": "LiveKit 服务器 URL"
                    },
                    "status": {
                      "type": "integer",
                      "description": "房间状态（0: 未开始, 1: 进行中, 2: 已结束, 3: 已取消, 4: 已拒绝, 5: 通话中未接听, 6: 超时未加入）"
                    },
                    "created_at": {
                      "type": "string",
                      "description": "创建时间"
                    },
                    "max_participants": {
                      "type": "integer",
                      "description": "最大参与者数"
                    },
                    "timeout": {
                      "type": "integer",
                      "description": "超时时间（秒）"
                    },
                    "rtc_type": {
                      "type": "integer",
                      "description": "呼叫类型（0: 语音, 1: 视频）"
                    },
                    "uids": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "所有参与者的 UID 列表"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "业务错误（通过响应体中的 code 字段区分具体错误类型）",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "integer",
                      "description": "错误码：400-参数错误，409-用户正在通话中"
                    },
                    "message": {
                      "type": "string",
                      "description": "错误消息"
                    }
                  }
                },
                "examples": {
                  "invalid_parameters": {
                    "summary": "参数错误",
                    "value": {
                      "code": 400,
                      "message": "参数错误"
                    }
                  },
                  "participant_in_call": {
                    "summary": "用户正在通话中（code=409）",
                    "description": "如果max_participants=2，且用户正在通话中，无法创建房间",
                    "value": {
                      "code": 409,
                      "message": "参与者 user_002 正在通话中，无法邀请"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "服务器内部错误",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "integer",
                      "example": 500
                    },
                    "message": {
                      "type": "string",
                      "example": "服务器内部错误"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/rooms/{room_id}/invite": {
      "post": {
        "tags": ["房间管理"],
        "summary": "邀请参与者",
        "parameters": [
          {
            "name": "room_id",
            "in": "path",
            "description": "房间 ID",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "description": "邀请参与者请求体",
                "required": ["uids"],
                "properties": {
                  "uids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "邀请成功"
          },
          "400": {
            "description": "请求参数错误"
          },
          "404": {
            "description": "房间不存在"
          }
        }
      }
    },
    "/api/v1/rooms/{room_id}/join": {
      "post": {
        "tags": ["房间管理"],
        "summary": "加入房间",
        "parameters": [
          {
            "name": "room_id",
            "description": "房间 ID",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "description": "加入房间请求体",
                "required": ["uid"],
                "properties": {
                  "uid": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "加入房间成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "source_channel_id": {
                      "type": "string",
                      "description": "来源渠道 ID"
                    },
                    "source_channel_type": {
                      "type": "integer",
                      "description": "来源渠道类型"
                    },
                    "room_id": {
                      "type": "string",
                      "description": "房间 ID"
                    },
                    "creator": {
                      "type": "string",
                      "description": "房间创建者 ID"
                    },
                    "token": {
                      "type": "string",
                      "description": "LiveKit Token"
                    },
                    "url": {
                      "type": "string",
                      "description": "LiveKit 服务器 URL"
                    },
                    "status": {
                      "type": "integer",
                      "description": "房间状态（0: 未开始, 1: 进行中, 2: 已结束, 3: 已取消, 4: 已拒绝, 5: 通话中未接听, 6: 超时未加入）"
                    },
                    "created_at": {
                      "type": "string",
                      "description": "创建时间"
                    },
                    "max_participants": {
                      "type": "integer",
                      "description": "最大参与者数"
                    },
                    "timeout": {
                      "type": "integer",
                      "description": "超时时间（秒）"
                    },
                    "rtc_type": {
                      "type": "integer",
                      "description": "呼叫类型（0: 语音, 1: 视频）"
                    },
                    "uids": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "所有参与者的 UID 列表"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误"
          },
          "404": {
            "description": "房间不存在"
          }
        }
      }
    },
    "/api/v1/rooms/{room_id}/leave": {
      "post": {
        "tags": ["房间管理"],
        "summary": "离开房间",
        "parameters": [
          {
            "name": "room_id",
            "description": "房间 ID",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["uid"],
                "description": "离开房间请求体",
                "properties": {
                  "uid": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "离开房间成功"
          },
          "400": {
            "description": "请求参数错误"
          },
          "404": {
            "description": "房间或参与者不存在"
          }
        }
      }
    },
    "/api/v1/rooms/sync": {
      "get": {
        "tags": ["房间管理"],
        "summary": "同步用户可加入的房间列表",
        "description": "同步指定用户被邀请或已加入的所有活跃房间列表",
        "parameters": [
          {
            "name": "uid",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "用户 ID",
            "example": "user_001"
          }
        ],
        "responses": {
          "200": {
            "description": "查询成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "source_channel_id": {
                        "type": "string",
                        "description": "来源渠道 ID"
                      },
                      "source_channel_type": {
                        "type": "integer",
                        "description": "来源渠道类型"
                      },
                      "room_id": {
                        "type": "string",
                        "description": "房间 ID"
                      },
                      "creator": {
                        "type": "string",
                        "description": "房间创建者 ID"
                      },
                      "token": {
                        "type": "string",
                        "description": "LiveKit Token"
                      },
                      "url": {
                        "type": "string",
                        "description": "LiveKit 服务器 URL"
                      },
                      "status": {
                        "type": "integer",
                        "description": "房间状态（0: 未开始, 1: 进行中, 2: 已结束, 3: 已取消, 4: 已拒绝, 5: 通话中未接听, 6: 超时未加入）"
                      },
                      "created_at": {
                        "type": "string",
                        "description": "创建时间"
                      },
                      "max_participants": {
                        "type": "integer",
                        "description": "最大参与者数"
                      },
                      "timeout": {
                        "type": "integer",
                        "description": "超时时间（秒）"
                      },
                      "uids": {
                        "type": "array",
                        "items": {
                          "type": "string"
                        },
                        "description": "所有参与者的 UID 列表"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误"
          }
        }
      }
    },
    "/api/v1/webhooks/livekit": {
      "post": {
        "tags": ["Webhook"],
        "summary": "LiveKit Webhook",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "事件处理成功"
          },
          "400": {
            "description": "事件解析失败"
          },
          "401": {
            "description": "验证失败"
          }
        }
      }
    },
    "/api/v1/webhooks/logs/stats": {
      "get": {
        "tags": ["Webhook"],
        "summary": "获取 Webhook 日志统计",
        "responses": {
          "200": {
            "description": "获取成功"
          },
          "500": {
            "description": "服务器内部错误"
          }
        }
      }
    },
    "/api/v1/webhooks/logs/cleanup": {
      "post": {
        "tags": ["Webhook"],
        "summary": "清理 Webhook 日志",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["retention_days"],
                "properties": {
                  "retention_days": {
                    "type": "integer",
                    "minimum": 1
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "日志清理成功"
          },
          "400": {
            "description": "请求参数错误"
          },
          "500": {
            "description": "服务器内部错误"
          }
        }
      }
    },
    "/tgortc/webhook": {
      "post": {
        "tags": ["业务 Webhook"],
        "summary": "业务 Webhook 回调接口",
        "description": "TgoRTC 服务器会向业务系统配置的 Webhook URL 发送事件通知。业务系统需要实现此接口来接收事件。\n\n**请求格式：**\n- **Query 参数**: `event_type` 和 `event_id`\n- **Body**: JSON 数据（房间事件使用 `RoomEventData`，参与者事件使用 `ParticipantEventData`）\n\n**事件类型说明：**\n\n**房间事件：**\n- `room.started` - 房间已开始（第一个参与者加入时触发）\n- `room.finished` - 房间已结束（所有参与者离开或超时时触发）\n\n**参与者事件：**\n- `participant.joined` - 参与者已加入（参与者成功加入房间）\n- `participant.left` - 参与者已离开（参与者正常离开房间）\n- `participant.rejected` - 参与者已拒绝（参与者拒绝加入房间）\n- `participant.missed` - 参与者已超时（参与者未在规定时间内加入）\n- `participant.cancelled` - 参与者已取消（发起者取消了对参与者的邀请）",
        "parameters": [
          {
            "name": "event_type",
            "in": "query",
            "required": true,
            "description": "事件类型",
            "schema": {
              "type": "string",
              "enum": [
                "room.started",
                "room.finished",
                "participant.joined",
                "participant.left",
                "participant.rejected",
                "participant.missed",
                "participant.cancelled"
              ]
            },
            "example": "participant.joined"
          },
          {
            "name": "event_id",
            "in": "query",
            "required": true,
            "description": "事件唯一 ID（用于去重）",
            "schema": {
              "type": "string"
            },
            "example": "1704096600-abc123"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "oneOf": [
                  {
                    "$ref": "#/components/schemas/RoomEventData"
                  },
                  {
                    "$ref": "#/components/schemas/ParticipantEventData"
                  }
                ],
                "description": "事件数据（房间事件使用 RoomEventData，参与者事件使用 ParticipantEventData）"
              },
              "examples": {
                "room.started": {
                  "summary": "房间已开始事件",
                  "description": "请求 URL: /tgortc/webhook?event_type=room.started&event_id=1704096600-abc123",
                  "value": {
                    "source_channel_id": "channel_001",
                    "source_channel_type": 0,
                    "room_id": "room_abc123",
                    "creator": "user_001",
                    "rtc_type": 1,
                    "invite_on": 0,
                    "status": 1,
                    "max_participants": 2,
                    "duration": 0,
                    "uids": ["user_001"],
                    "created_at": 1704096500,
                    "updated_at": 1704096600
                  }
                },
                "room.finished": {
                  "summary": "房间已结束事件",
                  "description": "请求 URL: /tgortc/webhook?event_type=room.finished&event_id=1704096900-xyz789",
                  "value": {
                    "source_channel_id": "channel_001",
                    "source_channel_type": 0,
                    "room_id": "room_abc123",
                    "creator": "user_001",
                    "rtc_type": 1,
                    "invite_on": 0,
                    "status": 2,
                    "max_participants": 2,
                    "duration": 300,
                    "uids": ["user_001", "user_002"],
                    "created_at": 1704096500,
                    "updated_at": 1704096900
                  }
                },
                "participant.joined": {
                  "summary": "参与者已加入事件",
                  "description": "请求 URL: /tgortc/webhook?event_type=participant.joined&event_id=1704096700-def456",
                  "value": {
                    "source_channel_id": "channel_001",
                    "source_channel_type": 0,
                    "room_id": "room_abc123",
                    "creator": "user_001",
                    "rtc_type": 1,
                    "invite_on": 0,
                    "status": 1,
                    "max_participants": 2,
                    "duration": 0,
                    "uids": ["user_001", "user_002"],
                    "created_at": 1704096500,
                    "updated_at": 1704096700,
                    "uid": "user_002"
                  }
                },
                "participant.left": {
                  "summary": "参与者已离开事件",
                  "description": "请求 URL: /tgortc/webhook?event_type=participant.left&event_id=1704096800-ghi789",
                  "value": {
                    "source_channel_id": "channel_001",
                    "source_channel_type": 0,
                    "room_id": "room_abc123",
                    "creator": "user_001",
                    "rtc_type": 1,
                    "invite_on": 0,
                    "status": 2,
                    "max_participants": 2,
                    "duration": 0,
                    "uids": ["user_001", "user_002"],
                    "created_at": 1704096500,
                    "updated_at": 1704096800,
                    "uid": "user_002"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "事件接收成功"
          },
          "400": {
            "description": "请求参数错误"
          },
          "500": {
            "description": "业务系统处理失败"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "RoomEventData": {
        "type": "object",
        "description": "房间事件数据（用于 room.started、room.finished 事件）",
        "required": ["source_channel_id", "room_id", "creator", "rtc_type", "status", "max_participants", "created_at", "updated_at"],
        "properties": {
          "source_channel_id": {
            "type": "string",
            "description": "来源渠道 ID",
            "example": "channel_001"
          },
          "source_channel_type": {
            "type": "integer",
            "description": "来源渠道类型",
            "example": 0
          },
          "room_id": {
            "type": "string",
            "description": "房间 ID",
            "example": "room_abc123"
          },
          "creator": {
            "type": "string",
            "description": "房间创建者 UID",
            "example": "user_001"
          },
          "rtc_type": {
            "type": "integer",
            "description": "RTC 类型（1=音视频，2=仅音频）",
            "example": 1
          },
          "invite_on": {
            "type": "integer",
            "description": "邀请方式",
            "example": 0
          },
          "status": {
            "type": "integer",
            "description": "房间状态（0=未开始，1=进行中，2=已结束，3=已取消，4=已拒绝，5=通话中未接听，6=超时未加入）",
            "example": 1
          },
          "max_participants": {
            "type": "integer",
            "description": "最大参与者数量",
            "example": 2
          },
          "duration": {
            "type": "integer",
            "format": "int64",
            "description": "通话时长（秒），仅在 room.finished 事件中有值",
            "example": 300
          },
          "uids": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "参与者 UID 列表",
            "example": ["user_001", "user_002"]
          },
          "created_at": {
            "type": "integer",
            "format": "int64",
            "description": "创建时间戳（秒）",
            "example": 1704096500
          },
          "updated_at": {
            "type": "integer",
            "format": "int64",
            "description": "更新时间戳（秒）",
            "example": 1704096600
          }
        }
      },
      "ParticipantEventData": {
        "type": "object",
        "description": "参与者事件数据（用于 participant.joined、participant.left、participant.rejected、participant.missed、participant.cancelled 事件）",
        "allOf": [
          {
            "$ref": "#/components/schemas/RoomEventData"
          },
          {
            "type": "object",
            "required": ["uid"],
            "properties": {
              "uid": {
                "type": "string",
                "description": "操作者 UID（加入者/离开者/拒绝者等）",
                "example": "user_002"
              }
            }
          }
        ]
      }
    }
  }
}

