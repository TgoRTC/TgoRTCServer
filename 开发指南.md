# 开发指南

## 环境要求

- Go 1.21 或更高版本
- MySQL 5.7 或更高版本
- Redis 5.0 或更高版本
- LiveKit 服务器

## 本地开发环境搭建

### 1. 克隆项目

```bash
git clone <repository-url>
cd tgo-call-server
```

### 2. 安装依赖

```bash
go mod download
```

### 3. 配置环境变量

```bash
cp .env.example .env
```

编辑 `.env` 文件，配置本地开发环境：

```bash
# 服务配置
PORT=8080
ENV=development
LOG_LEVEL=debug

# 数据库配置（本地 MySQL）
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=tgo_call

# Redis 配置（本地 Redis）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# LiveKit 配置
LIVEKIT_URL=http://localhost:7880
LIVEKIT_API_KEY=your_api_key
LIVEKIT_API_SECRET=your_api_secret
```

### 4. 创建数据库

```bash
mysql -u root -p
```

```sql
CREATE DATABASE tgo_call CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 5. 启动服务

```bash
go run main.go
```

服务将在 `http://localhost:8080` 启动。

## 代码规范

### 命名规范

- **包名**: 小写，单词，如 `config`, `database`, `models`
- **函数名**: 大驼峰式，如 `CreateRoom`, `GetParticipants`
- **变量名**: 小驼峰式，如 `roomName`, `participantID`
- **常量名**: 大写下划线式，如 `ROOM_STATUS_ACTIVE`

### 文件组织

```
internal/
├── config/          # 配置相关
├── database/        # 数据库相关
├── models/          # 数据模型
├── service/         # 业务逻辑
├── handler/         # HTTP 处理器
├── livekit/         # LiveKit 集成
└── router/          # 路由配置
```

### 错误处理

统一使用 `fmt.Errorf` 包装错误：

```go
if err != nil {
    return nil, fmt.Errorf("操作失败: %w", err)
}
```

### 日志输出

使用标准库 `log` 包：

```go
log.Println("信息")
log.Printf("格式化信息: %v", value)
log.Fatalf("致命错误: %v", err)
```

## 常见开发任务

### 添加新的 API 接口

#### 步骤 1: 定义数据模型

在 `internal/models/` 中创建或修改模型文件：

```go
// internal/models/example.go
type ExampleRequest struct {
    Name string `json:"name" binding:"required"`
}

type ExampleResponse struct {
    ID   int    `json:"id"`
    Name string `json:"name"`
}
```

#### 步骤 2: 实现业务逻辑

在 `internal/service/` 中创建或修改服务文件：

```go
// internal/service/example_service.go
func (es *ExampleService) DoSomething(req *models.ExampleRequest) (*models.ExampleResponse, error) {
    // 业务逻辑
    return &models.ExampleResponse{...}, nil
}
```

#### 步骤 3: 创建 HTTP 处理器

在 `internal/handler/` 中创建或修改处理器文件：

```go
// internal/handler/example_handler.go
func (eh *ExampleHandler) HandleExample(c *gin.Context) {
    var req models.ExampleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    resp, err := eh.exampleService.DoSomething(&req)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "code": 0,
        "msg":  "操作成功",
        "data": resp,
    })
}
```

#### 步骤 4: 配置路由

在 `internal/router/router.go` 中添加路由：

```go
api.POST("/example", exampleHandler.HandleExample)
```

### 修改数据库模型

1. 修改 `internal/models/` 中的结构体
2. GORM 会自动执行迁移（添加新字段）
3. 重启服务

### 调试技巧

#### 启用调试日志

修改 `.env` 中的 `LOG_LEVEL`:

```bash
LOG_LEVEL=debug
```

#### 使用 Postman 测试 API

1. 打开 Postman
2. 创建新的请求
3. 设置请求方法和 URL
4. 添加请求体（JSON）
5. 发送请求

#### 查看数据库

```bash
mysql -u root -p tgo_call
```

```sql
SELECT * FROM livekit_room;
SELECT * FROM livekit_participant;
```

#### 查看 Redis

```bash
redis-cli
```

```
KEYS *
GET key_name
```

## 测试

### 单元测试

创建测试文件 `*_test.go`:

```go
package service

import (
    "testing"
)

func TestCreateRoom(t *testing.T) {
    // 测试代码
}
```

运行测试：

```bash
go test ./...
```

### 集成测试

使用 Postman 或 curl 测试 API：

```bash
# 创建房间
curl -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "source_channel_id": "channel_123",
    "source_channel_type": 0,
    "creator": "user_001",
    "room_name": "meeting_001",
    "call_type": 1,
    "invite_on": 1
  }'

# 获取房间信息
curl http://localhost:8080/api/rooms/meeting_001

# 加入房间
curl -X POST http://localhost:8080/api/participants/join \
  -H "Content-Type: application/json" \
  -d '{
    "room_name": "meeting_001",
    "uid": "user_002"
  }'
```

## 性能优化

### 数据库优化

1. 添加适当的索引
2. 使用连接池
3. 避免 N+1 查询

### 缓存优化

1. 使用 Redis 缓存热点数据
2. 设置合理的过期时间
3. 实现缓存预热

### 并发优化

1. 使用 goroutine 处理异步任务
2. 使用 channel 进行通信
3. 避免竞态条件

## 部署

### 构建

```bash
go build -o tgo-call-server
```

### 运行

```bash
./tgo-call-server
```

### Docker 部署

创建 `Dockerfile`:

```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o tgo-call-server

FROM alpine:latest
WORKDIR /root/
COPY --from=builder /app/tgo-call-server .
COPY .env .
EXPOSE 8080
CMD ["./tgo-call-server"]
```

构建镜像：

```bash
docker build -t tgo-call-server:latest .
```

运行容器：

```bash
docker run -p 8080:8080 --env-file .env tgo-call-server:latest
```

## 常见问题

### 数据库连接失败

检查：
1. MySQL 是否运行
2. 数据库凭证是否正确
3. 数据库是否存在

### Redis 连接失败

检查：
1. Redis 是否运行
2. Redis 地址和端口是否正确
3. Redis 密码是否正确

### LiveKit Token 生成失败

检查：
1. LiveKit API Key 和 Secret 是否正确
2. LiveKit 服务器是否运行

## 相关文档

- [API 文档](API_文档.md)
- [项目结构说明](项目结构说明.md)
- [数据库字段说明](数据库字段说明.md)
- [部署架构指南](部署架构指南.md)

